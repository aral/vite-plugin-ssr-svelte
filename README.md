# vite-plugin-ssr example with automatic TLS

This example modifies the default vite-ssr-project template generated by [vite-plugin-ssr](https://vite-plugin-ssr.com/) to add automatic TLS using [@small-tech/https](https://github.com/small-tech/https) (via mkcert during development and via Let’s Encrypt during production) and [@small-tech/cross-platform-hostname](https://github.com/small-tech/cross-platform-hostname).

## Install and run

1. Clone this repository
2. Run `npm run dev`
3. Hit `https://localhost`

## Recreate the example

Here is a short tutorial on how to recreate this example, starting with the default vite-plugin-ssr vue template:

1. Scaffold a new vite-plugin-ssr app and choose the vue template:

    ```shell
    npm init vite-plugin-ssr@latest
    ```

2. Install the dependencies:

    ```shell
    npm i @small-tech/https
    npm i @small-tech/cross-platform-hostname
    ```

3. Modify server/index.js to:

    1. Load the dependencies:

        ```js
        const https = require('@small-tech/https')
        const hostname = require('@small-tech/cross-platform-hostname')
        ```

    2. Use `@small-tech/https` to create and start your server:

        ```js
        const server = isProduction ?
          https.createServer({ domains: [hostname] }, app) : https.createServer(app)

        server.listen(443, () => {
          console.log(`Server running at https://${isProduction ? hostname : 'localhost'}`)
        })
        ```

That’s it!

## Test it (development)

Run `npm run dev` and hit `https://localhost`

## Test it (production)

1. Expose your dev machine using something like [PageKite](https://pagekite.net/) or [ngrok](ngrok.com)
2. Run `npm run prod`
3. Hit `https://your.hostname`

(In production, the first load will take a few seconds as your Let’s Encrypt certificates are automatically provisioned for you.)

## Patch

Here’s the full diff of the changes for adding automatic TLS during development and production:

```patch
diff --git a/package.json b/package.json
index 1c1c3c0..ae110e9 100644
--- a/package.json
+++ b/package.json
@@ -7,6 +7,8 @@
     "server:prod": "cross-env NODE_ENV=production node ./server"
   },
   "dependencies": {
+    "@small-tech/cross-platform-hostname": "^1.0.0",
+    "@small-tech/https": "^2.1.2",
     "@vitejs/plugin-vue": "^1.2.3",
     "@vue/compiler-sfc": "^3.0.11",
     "@vue/server-renderer": "^3.0.11",
diff --git a/server/index.js b/server/index.js
index a9db3c7..d9ecacb 100644
--- a/server/index.js
+++ b/server/index.js
@@ -1,5 +1,7 @@
 const express = require('express')
 const { createPageRender } = require('vite-plugin-ssr')
+const https = require('@small-tech/https')
+const hostname = require('@small-tech/cross-platform-hostname')
 
 const isProduction = process.env.NODE_ENV === 'production'
 const root = `${__dirname}/..`
@@ -32,7 +34,8 @@ async function startServer() {
     res.status(result.statusCode).send(result.renderResult)
   })
 
-  const port = process.env.PORT || 3000
-  app.listen(port)
-  console.log(`Server running at http://localhost:${port}`)
+  const server = isProduction ? https.createServer({ domains: [hostname] }, app) : https.createServer(app)
+  server.listen(443, () => {
+    console.log(`Server running at https://${isProduction ? hostname : 'localhost'}`)
+  })
 }
```